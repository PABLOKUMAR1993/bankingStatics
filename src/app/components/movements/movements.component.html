<div class="movements-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Movimientos</h1>
    <p class="page-subtitle">Visualiza y gestiona todas tus transacciones</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando transacciones...</p>
  </div>

  <!-- Content -->
  <div *ngIf="!loading">
    <!-- Filter Section -->
    <mat-card class="filter-card">
      <mat-card-content>
        <div class="filter-header">
          <button mat-button (click)="toggleFilters()" class="filter-toggle">
            <mat-icon>{{ showFilters ? 'expand_less' : 'expand_more' }}</mat-icon>
            Filtros y Ordenación
          </button>
        </div>
        
        <div *ngIf="showFilters" class="filter-content">
          <form [formGroup]="filterForm">
            <div class="filter-grid">
              <!-- Date Filters -->
              <mat-form-field>
                <mat-label>Fecha Operación Desde</mat-label>
                <input matInput [matDatepicker]="operationFromPicker" formControlName="operationDateFrom" (dateChange)="onFilterChange()">
                <mat-datepicker-toggle matIconSuffix [for]="operationFromPicker"></mat-datepicker-toggle>
                <mat-datepicker #operationFromPicker></mat-datepicker>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Fecha Operación Hasta</mat-label>
                <input matInput [matDatepicker]="operationToPicker" formControlName="operationDateTo" (dateChange)="onFilterChange()">
                <mat-datepicker-toggle matIconSuffix [for]="operationToPicker"></mat-datepicker-toggle>
                <mat-datepicker #operationToPicker></mat-datepicker>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Fecha Valor Desde</mat-label>
                <input matInput [matDatepicker]="valueFromPicker" formControlName="valueDateFrom" (dateChange)="onFilterChange()">
                <mat-datepicker-toggle matIconSuffix [for]="valueFromPicker"></mat-datepicker-toggle>
                <mat-datepicker #valueFromPicker></mat-datepicker>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Fecha Valor Hasta</mat-label>
                <input matInput [matDatepicker]="valueToPicker" formControlName="valueDateTo" (dateChange)="onFilterChange()">
                <mat-datepicker-toggle matIconSuffix [for]="valueToPicker"></mat-datepicker-toggle>
                <mat-datepicker #valueToPicker></mat-datepicker>
              </mat-form-field>
              
              <!-- Search and Amount Filters -->
              <mat-form-field>
                <mat-label>Concepto</mat-label>
                <input matInput formControlName="concept" placeholder="Buscar..." (keydown.enter)="onFilterChange()">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Pagos Desde</mat-label>
                <input matInput type="number" formControlName="paymentAmountFrom" (keydown.enter)="onFilterChange()">
                <span matTextSuffix>€</span>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Pagos Hasta</mat-label>
                <input matInput type="number" formControlName="paymentAmountTo" (keydown.enter)="onFilterChange()">
                <span matTextSuffix>€</span>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Ingresos Desde</mat-label>
                <input matInput type="number" formControlName="incomeAmountFrom" (keydown.enter)="onFilterChange()">
                <span matTextSuffix>€</span>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Ingresos Hasta</mat-label>
                <input matInput type="number" formControlName="incomeAmountTo" (keydown.enter)="onFilterChange()">
                <span matTextSuffix>€</span>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Categorías</mat-label>
                <mat-select formControlName="categoryIds" multiple>
                  <mat-option *ngFor="let category of categories" [value]="category.id">
                    <span class="category-chip" [style.background-color]="category.color">
                      {{ category.name }}
                    </span>
                  </mat-option>
                </mat-select>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Ordenar por</mat-label>
                <mat-select formControlName="sortBy">
                  <mat-option *ngFor="let option of sortOptions" [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              
              <mat-form-field>
                <mat-label>Dirección</mat-label>
                <mat-select formControlName="sortDirection">
                  <mat-option *ngFor="let option of sortDirectionOptions" [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            
            <!-- Action Buttons -->
            <div class="filter-actions">
              <button mat-raised-button color="primary" (click)="onFilterChange()">
                <mat-icon>search</mat-icon>
                Buscar
              </button>
              <button mat-button (click)="clearFilters()">
                <mat-icon>clear</mat-icon>
                Limpiar
              </button>
            </div>
          </form>
        </div>
      </mat-card-content>
    </mat-card>
    
    <!-- Summary Card -->
    <mat-card class="summary-card" *ngIf="currentBalance && currentBalance.hasTransactions">
      <mat-card-content>
        <div class="summary-content">
          <div class="summary-info">
            <h3>Saldo Actual</h3>
            <p class="summary-date" *ngIf="currentBalance.lastTransactionDate">
              Última transacción: {{ formatDate(currentBalance.lastTransactionDate) }}
            </p>
          </div>
          <div class="summary-amount">{{ formatCurrency(currentBalance.currentBalance) }}</div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Transactions Table -->
    <mat-card class="table-card">
      <mat-card-content>
        <div class="table-header">
          <h2>Transacciones ({{ totalElements }} resultados)</h2>
        </div>
        
        <div class="table-container">
          <table mat-table [dataSource]="transactions" class="transactions-table">

            <ng-container matColumnDef="fechaOperacion">
              <th mat-header-cell *matHeaderCellDef>Fecha</th>
              <td mat-cell *matCellDef="let transaction">{{ formatDate(transaction.fechaOperacion) }}</td>
            </ng-container>

            <ng-container matColumnDef="concepto">
              <th mat-header-cell *matHeaderCellDef>Concepto</th>
              <td mat-cell *matCellDef="let transaction" class="concepto-cell">{{ transaction.concepto }}</td>
            </ng-container>

            <ng-container matColumnDef="categoria">
              <th mat-header-cell *matHeaderCellDef>Categoría</th>
              <td mat-cell *matCellDef="let transaction">
                <mat-select 
                  [value]="transaction.category.id"
                  (selectionChange)="onCategoryChange(transaction, $event.value)"
                  class="category-select">
                  <mat-select-trigger>
                    <span class="category-chip-selected" [style.background-color]="transaction.category.color">
                      {{ transaction.category.name }}
                    </span>
                  </mat-select-trigger>
                  <mat-option 
                    *ngFor="let category of categories"
                    [value]="category.id">
                    <span class="category-option" [style.background-color]="category.color">
                      {{ category.name }}
                    </span>
                  </mat-option>
                </mat-select>
              </td>
            </ng-container>

            <ng-container matColumnDef="pagos">
              <th mat-header-cell *matHeaderCellDef class="amount-header">Pagos</th>
              <td mat-cell *matCellDef="let transaction" class="amount-cell negative">
                <span *ngIf="transaction.pagos">{{ formatCurrency(transaction.pagos) }}</span>
                <span *ngIf="!transaction.pagos" class="no-amount">-</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="ingresos">
              <th mat-header-cell *matHeaderCellDef class="amount-header">Ingresos</th>
              <td mat-cell *matCellDef="let transaction" class="amount-cell positive">
                <span *ngIf="transaction.ingresos">{{ formatCurrency(transaction.ingresos) }}</span>
                <span *ngIf="!transaction.ingresos" class="no-amount">-</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="saldo">
              <th mat-header-cell *matHeaderCellDef class="amount-header">Saldo</th>
              <td mat-cell *matCellDef="let transaction" class="amount-cell saldo">
                {{ formatCurrency(transaction.saldo) }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="transaction-row"></tr>
          </table>
        </div>

        <!-- Paginator -->
        <mat-paginator
          [length]="totalElements"
          [pageSize]="pageSize"
          [pageIndex]="currentPage"
          [pageSizeOptions]="pageSizeOptions"
          (page)="onPageChange($event)"
          showFirstLastButtons
          class="table-paginator">
        </mat-paginator>
      </mat-card-content>
    </mat-card>

    <!-- Empty State -->
    <div *ngIf="transactions.length === 0" class="empty-state">
      <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
      <h3>No hay transacciones</h3>
      <p>No se encontraron transacciones que coincidan con los filtros aplicados</p>
    </div>
  </div>
</div>